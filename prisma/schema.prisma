generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ===== Enums =====
 */

enum Role {
  ADMIN
  OPERADOR
  FABRICA
  CLIENTE
}

enum CategoriaGrade {
  G1000
  G2000
  G3000
  G4000
  G5000
  G6000
  G7000
  COURO
}

/**
 * ===== Usuário / Autenticação =====
 */

model User {
  id               String    @id @default(cuid())
  name             String?
  email            String    @unique
  password         String
  role             Role      @default(CLIENTE)
  emailVerificado  Boolean   @default(false)
  tokenVerificacao String?   @unique
  tokenExpiracao   DateTime?
  representante    Boolean   @default(false) // Flag para identificar representante/lojista
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  pedidos  Pedido[]
  carrinho Carrinho?

  @@index([tokenVerificacao])
  @@index([emailVerificado])
  @@index([representante])
}

/**
 * ===== Catálogo: Categoria / Família / Produto =====
 */

model Categoria {
  id        String    @id @default(cuid())
  nome      String
  ativo     Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  familias  Familia[]
  produtos  Produto[]
}

model Familia {
  id            String   @id @default(cuid())
  categoriaId   String?
  nome          String
  descricao     String?
  ativo         Boolean  @default(true)
  // Perfil padrão para gerar variações em lote (usado pelo botão "Criar variações")
  // Formato sugerido: { medidas: [80,90,100,110,120], dimensoes: { "80": { largura:.., profundidade:.., altura:.. }, ... }, metragem: { tecido:{...}, couro:{...} } }
  perfilMedidas Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  categoria Categoria? @relation(fields: [categoriaId], references: [id])
  produtos  Produto[]
}

model NomePadraoProduto {
  id        String   @id @default(cuid())
  nome      String   @unique
  ativo     Boolean  @default(true)
  ordem     Int? // Ordem de exibição (opcional)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ativo])
  @@index([ordem])
}

model Produto {
  id           String   @id @default(cuid())
  categoriaId  String
  familiaId    String
  nome         String
  tipo         String? // ex.: Modular
  abertura     String? // ex.: Retrátil
  acionamento  String? // ex.: Manual
  configuracao String? // ex.: Módulo com braço
  status       Boolean  @default(true)
  imagens      String[] // URLs (mantido para compatibilidade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  categoria         Categoria          @relation(fields: [categoriaId], references: [id])
  familia           Familia            @relation(fields: [familiaId], references: [id])
  tecidos           ProdutoTecido[]
  variacoes         Variacao[]
  precos            TabelaPrecoLinha[]
  itens             PedidoItem[]
  carrinhoItems     CarrinhoItem[]
  imagensDetalhadas ProdutoImagem[]

  @@index([familiaId, categoriaId])
}

/**
 * ===== Tecidos (por Grade) e Vínculo Produto↔Tecido =====
 */

model Tecido {
  id             String         @id @default(cuid())
  nome           String
  grade          CategoriaGrade
  imagemUrl      String?
  fornecedorNome String? // Nome do fornecedor
  valor_m2       Decimal?       @db.Decimal(10, 2) // Valor do tecido por m²
  ativo          Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  produtos       ProdutoTecido[]
  pedidoItems    PedidoItem[]
  carrinhoItems  CarrinhoItem[]
  produtoImagens ProdutoImagem[]

  @@index([grade])
}

model ProdutoTecido {
  produtoId String
  tecidoId  String

  produto Produto @relation(fields: [produtoId], references: [id])
  tecido  Tecido  @relation(fields: [tecidoId], references: [id])

  @@id([produtoId, tecidoId]) // N:N sem payload
}

/**
 * ===== Imagens de Produto vinculadas a Tecidos =====
 */
model ProdutoImagem {
  id        String   @id @default(cuid())
  produtoId String
  url       String // URL da imagem
  tecidoId  String? // null = aparece em todos os tecidos
  tipo      String   @default("complementar") // principal, complementar, extra
  ordem     Int      @default(0) // Ordem de exibição
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  produto Produto @relation(fields: [produtoId], references: [id], onDelete: Cascade)
  tecido  Tecido? @relation(fields: [tecidoId], references: [id], onDelete: SetNull)

  @@index([produtoId])
  @@index([tecidoId])
  @@index([produtoId, tecidoId])
}

/**
 * ===== Variações (Medidas por Produto) =====
 */

model Variacao {
  id                 String @id @default(cuid())
  produtoId          String
  medida_cm          Int
  largura_cm         Int
  profundidade_cm    Int
  altura_cm          Int
  largura_assento_cm Int    @default(0)
  altura_assento_cm  Int    @default(0)
  largura_braco_cm   Int    @default(0)
  metragem_tecido_m  Float
  metragem_couro_m   Float

  produto Produto @relation(fields: [produtoId], references: [id])

  // Cada produto só pode ter uma variação por medida
  @@unique([produtoId, medida_cm])
}

/**
 * ===== Gestão de Tabelas de Preços =====
 * Permite criar múltiplas tabelas de preços distintas
 */
model TabelaPreco {
  id        String  @id @default(cuid())
  nome      String // Nome da tabela de preços
  ativo     Boolean @default(true) // Status ativo/inativo
  descricao String? // Descrição opcional

  linhas      TabelaPrecoLinha[] // Linhas de preço vinculadas a esta tabela
  siteConfigs SiteConfig[] // Configurações do site que usam esta tabela

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ativo])
}

/**
 * ===== Tabela de Preço (espelha o PRINT) =====
 * Uma linha por (Produto × Medida)
 * Colunas fixas: Grades 1000..7000 + Couro, além de metragem de tecido e couro
 */
model TabelaPrecoLinha {
  id String @id @default(cuid())

  produtoId     String
  tabelaPrecoId String? // Vinculação opcional a uma tabela de preços específica

  // Campos textuais redundantes para CSV/planilha (facilita export/import e UI sem JOIN)
  nomeProduto    String?
  categoriaTxt   String? // ex.: "Sofá"
  familiaTxt     String? // ex.: "TEMPO"
  tipoTxt        String?
  aberturaTxt    String?
  acionamentoTxt String?

  // Chave de linha
  medida_cm          Int
  largura_cm         Int
  profundidade_cm    Int
  altura_cm          Int
  largura_assento_cm Int @default(0)
  altura_assento_cm  Int @default(0)
  largura_braco_cm   Int @default(0)

  // Consumos
  metragem_tecido_m Float // aparece como "Metragem Tecido (m)" na planilha
  metragem_couro_m  Float // aparece como "Metragem Couro (m)"

  // Preços finais por grade (uma coluna por grade) + couro
  preco_grade_1000 Decimal @db.Decimal(10, 2)
  preco_grade_2000 Decimal @db.Decimal(10, 2)
  preco_grade_3000 Decimal @db.Decimal(10, 2)
  preco_grade_4000 Decimal @db.Decimal(10, 2)
  preco_grade_5000 Decimal @db.Decimal(10, 2)
  preco_grade_6000 Decimal @db.Decimal(10, 2)
  preco_grade_7000 Decimal @db.Decimal(10, 2)
  preco_couro      Decimal @db.Decimal(10, 2)

  produto     Produto      @relation(fields: [produtoId], references: [id])
  tabelaPreco TabelaPreco? @relation(fields: [tabelaPrecoId], references: [id], onDelete: SetNull)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Unique constraint: permite múltiplas linhas com mesmo produto+medida se tabelaPrecoId ou acionamentoTxt for diferente
  // Para linhas sem tabela específica (tabelaPrecoId = NULL): único por produtoId+medida_cm+acionamentoTxt
  // Para linhas com tabela específica: único por tabelaPrecoId+produtoId+medida_cm+acionamentoTxt
  @@unique([produtoId, medida_cm, tabelaPrecoId, acionamentoTxt])
  @@index([produtoId, medida_cm])
  @@index([tabelaPrecoId])
}

/**
 * ===== Pedidos e Histórico de Status =====
 */

model Pedido {
  id        String   @id @default(cuid())
  codigo    String   @unique // ex.: ORD-AB12CD
  clienteId String
  status    String   @default("Solicitado")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cliente   User                  @relation(fields: [clienteId], references: [id])
  itens     PedidoItem[]
  historico PedidoStatusHistory[]
  mensagens MensagemPedido[]
}

model PedidoItem {
  id                String  @id @default(cuid())
  pedidoId          String
  produtoId         String
  tecidoId          String
  variacaoMedida_cm Int
  quantidade        Int
  precoUnit         Decimal @db.Decimal(10, 2)

  pedido  Pedido  @relation(fields: [pedidoId], references: [id])
  produto Produto @relation(fields: [produtoId], references: [id])
  tecido  Tecido  @relation(fields: [tecidoId], references: [id])
}

model PedidoStatusHistory {
  id        String   @id @default(cuid())
  pedidoId  String
  status    String
  reason    String?
  userId    String?
  createdAt DateTime @default(now())

  pedido Pedido @relation(fields: [pedidoId], references: [id])

  @@index([pedidoId, createdAt])
}

/**
 * ===== Carrinho de Compras =====
 */

model Carrinho {
  id        String   @id @default(cuid())
  userId    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User           @relation(fields: [userId], references: [id])
  itens CarrinhoItem[]
}

model CarrinhoItem {
  id                String @id @default(cuid())
  carrinhoId        String
  produtoId         String
  tecidoId          String
  variacaoMedida_cm Int
  quantidade        Int    @default(1)

  // snapshot opcional (apenas para exibir carrinho rápido; o preço "oficial" será resolvido no checkout)
  previewPrecoUnit Decimal? @db.Decimal(10, 2)

  carrinho Carrinho @relation(fields: [carrinhoId], references: [id])
  produto  Produto  @relation(fields: [produtoId], references: [id])
  tecido   Tecido   @relation(fields: [tecidoId], references: [id])

  @@index([carrinhoId])
  @@index([produtoId, variacaoMedida_cm, tecidoId])
}

/**
 * ===== Mensagens de Pedido =====
 */

model MensagemPedido {
  id        String   @id @default(cuid())
  pedidoId  String
  userId    String? // null = mensagem do sistema
  role      Role? // redundante para exibição (ADMIN/OPERADOR/CLIENTE/FABRICA)
  texto     String
  createdAt DateTime @default(now())

  pedido Pedido @relation(fields: [pedidoId], references: [id])

  @@index([pedidoId, createdAt])
}

/**
 * ===== Log de E-mails Transacionais =====
 */

model EmailLog {
  id         String   @id @default(cuid())
  to         String
  subject    String
  template   String
  providerId String?
  status     String // ex.: queued, sent, failed
  meta       Json?
  createdAt  DateTime @default(now())

  @@index([createdAt])
}

/**
 * ===== Configurações do Site =====
 * Armazena as configurações de exibição do site (categorias em destaque, produtos em destaque, tabela de preço vigente, etc)
 */
model SiteConfig {
  id String @id @default("site-config") // Sempre o mesmo ID para garantir uma única configuração

  // Categorias selecionadas para exibir na home (IDs das categorias)
  categoriasDestaque String[] @default([])

  // Produtos selecionados para exibir na home como "Produtos em Destaque" (IDs dos produtos)
  produtosDestaque String[] @default([])

  // ID da tabela de preço que está vigente/ativa no momento
  tabelaPrecoVigenteId String?

  // Produtos ativos da tabela vigente (IDs dos produtos que estarão disponíveis no site)
  produtosAtivosTabelaVigente String[] @default([])

  // Ordem de exibição das categorias (opcional, para personalizar a ordem)
  ordemCategorias String[] @default([])

  // Configurações adicionais em JSON (para futuras expansões)
  configuracoesExtras Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relação opcional com TabelaPreco
  tabelaPrecoVigente TabelaPreco? @relation(fields: [tabelaPrecoVigenteId], references: [id], onDelete: SetNull)

  @@unique([id])
}
